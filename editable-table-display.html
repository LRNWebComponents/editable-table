<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../dropdown-select/dropdown-select.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../simple-colors/simple-colors.html">
<link rel="import" href="../responsive-utility/responsive-utility-behaviors.html">
<link rel="import" href="editable-table-behaviors.html">
<link rel="import" href="editable-table-sort.html">
<link rel="import" href="editable-table-filter.html">
<!--
`editable-table-display`
A LRN element
@demo demo/index.html

@microcopy - the mental model for this element
 -
 -
 -

-->

<dom-module id="editable-table-display">
  <template>
    <style is="custom-style">
      :host, :host[accent-color="none"] {
        display: block;
        width: 100%;
        max-width: 100%;
        overflow-x: scroll;
        --editable-table-light-weight: 200;
        --editable-table-medium-weight: 400;
        --editable-table-heavy-weight: 500;
        --editable-table-color: var(--simple-colors-foreground3, #222);
        --editable-table-bg-color: var(--simple-colors-background1, #fff);
        --editable-table-border-color: var(--simple-colors-background5, #999);
        --editable-table-caption-color:  var(--simple-colors-foreground3, #222);
        --editable-table-caption-bg-color: var(--simple-colors-background1, #fff);
        --editable-table-heading-color: var(--simple-colors-foreground1, #000);
        --editable-table-heading-bg-color: var(--simple-colors-background3, #ddd);
        --editable-table-stripe-bg-color: var(--simple-colors-background2, #eee);
      }
      :host[accent-color]{
        --editable-table-caption-color:  var(--simple-colors-accent-foreground3, #222);
        --editable-table-heading-bg-color: var(--simple-colors-accent-background2, #ddd);
        --editable-table-border-color: var(--simple-colors-accent-foreground5, #999);
      }
      :host[dark], :host[dark][accent-color="none"]{
        --editable-table-light-weight: 100;
        --editable-table-medium-weight: 300;
        --editable-table-heavy-weight: 400;
        --editable-table-color: var(--simple-colors-foreground1, #fff);
        --editable-table-bg-color:  var(--simple-colors-background3, #222);
        --editable-table-border-color: var(--simple-colors-background1, #000);
        --editable-table-caption-color:  var(--simple-colors-background3, #222);
        --editable-table-caption-bg-color: var(--simple-colors-foreground1, #fff);
        --editable-table-heading-bg-color: var(--simple-colors-background1, #000);
        --editable-table-heading-color: var(--simple-colors-foreground1, #fff);
        --editable-table-stripe-bg-color: var(--simple-colors-background2, #111);
      }
      :host[dark][accent-color]{
        --editable-table-caption-color:  var(--simple-colors-accent-background3, #000);
        --editable-table-heading-bg-color: var(--simple-colors-accent-background3, #000);
        --editable-table-border-color: var(--simple-colors-accent-foreground5, #000);
      }
      :host table {
        width: 100%;
        margin: 15px 0;
      }
      :host table,
      :host table caption,
      :host table th,
      :host table td {
        border-collapse: collapse;
        background-color: var(--editable-table-bg-color);
      } 
      :host table caption {
        font-size: 120%;
        font-weight: var(--editable-table-heavy-weight);
        color: var(--editable-table-caption-color);
        background-color: var(--editable-table-caption-bg-color);
        padding: 0.5em 0 0;
        width: 100%;
      } 
      :host[dark][bordered] table caption {
        padding: 0.5em 0 0 0.25em;
        border: 1px solid var(--editable-table-border-color);
        border-bottom: none;
      }
      :host table,
      :host table th,
      :host table td {
        font-weight: var(--editable-table-light-weight);
        color: var(--editable-table-color);
      } 
      :host table th, 
      :host table td {
        padding: 0.75em 0.25em;
      }
      :host[condensed] table th,
      :host[condensed] table td {
        padding: 0 0.25em;
      }
      :host table caption, 
      :host table th, 
      :host table td {
        text-align: left;
      }
      :host table th[numeric],
      :host table td[numeric] {
        text-align: var(--editable-table-numeric-text-align, unset);
      }
      :host table td[negative] .cell {
        color: var(--editable-table-negative-color, --editable-table-color);
      }
      :host[bordered] table th,
      :host[bordered] table td {
        border: 1px solid var(--editable-table-border-color);
      }
      :host[striped] table tbody tr:nth-child(2n) th,
      :host[striped] table tbody tr:nth-child(2n) td {
        background-color: var(--editable-table-stripe-bg-color);
      }
      :host[column-header] table thead th {
        font-weight: var(--editable-table-heavy-weight);
        color: var(--editable-table-heading-color);
        background-color: var(--editable-table-heading-bg-color);
      }
      :host[row-header] table tbody th {
        font-weight:  var(--editable-table-heavy-weight);
        color: var(--editable-table-heading-color);
      }
      :host[footer] table tfoot tr th, 
      :host[footer] table tfoot tr td {
        font-weight: var(--editable-table-heavy-weight);
        color: var(--editable-table-heading-color);
        border-top: 3px solid var(--editable-table-color);
      }
      :host table caption > div {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
      }
      :host table caption > div > div {
        padding-bottom: 8px;
        flex-grow: 1;
        width: auto;
      }
      :host editable-table-sort {
        width: 100%;
      }
      :host[responsive-size="xs"] table[transition] {
        opacity: 0;
        transition: opacity 5s;
      }
      :host:not([responsive-size="xs"]) #column, 
      :host[responsive-size="xs"] table th[xs-hidden],
      :host[responsive-size="xs"] table td[xs-hidden],
      :host[responsive-size="xs"] table[default-xs-display] th:nth-of-type(n+3), 
      :host[responsive-size="xs"] table[default-xs-display][row-header] td:nth-of-type(n+3), 
      :host[responsive-size="xs"] table[default-xs-display]:not([row-header]) td:nth-of-type(n+2) {
        display: none;
      }
    </style>
    <table id="table" default-xs-display>
      <caption>
        <div>
          <div>[[caption]]</div>
          <dropdown-select id="column" label$="[[tables.0.label]]" value="1">
            <template is="dom-repeat" items$="[[thead.0]]" as="col" index-as="index">
              <template is="dom-if" if="[[columnHeader]]">
                <paper-item id$="[[index]]" value$="[[index]]">[[col]]</paper-item>
              </template>
              <template is="dom-if" if="[[!columnHeader]]">
                <paper-item id$="[[index]]">Column [[index]]</paper-item>
              </template>
            </template>
          </dropdown-select>
        </div>
      </caption>
      <thead hidden="[[!columnHeader]]"> 
        <tr>
          <template is="dom-repeat" items$="[[thead.0]]" as="th" index-as="index">
            <th scope="col" numeric$="[[_isNumericColumn(index)]]">
              <template is="dom-if" if="[[sort]]" restamp> 
                <editable-table-sort sort="sort" column-number="[[index]]" text$="[[th]]"></editable-table-sort>
              </template>
              <template is="dom-if" if="[[!sort]]" restamp>[[th]]</template>
            </th>
          </template>
        </tr> 
      </thead>
      <tbody id="tbody"> 
        <template is="dom-repeat" items$="[[tbody]]" as="tr" filter="{{filterRows(filterColumn,filterText)}}" restamp>
          <tr>
            <template is="dom-repeat" items$="[[tr]]" as="cell" index-as="index" restamp>
              <template is="dom-if" if="[[_isRowHeader(rowHeader,index)]]" restamp>
                <th scope="row" numeric$="[[_isNumericColumn(index)]]">
                  <template is="dom-if" if="[[filter]]" restamp>
                    <editable-table-filter column-number="[[index]]" text$="[[cell]]"></editable-table-filter>                      
                  </template>
                  <template is="dom-if" if="[[!filter]]" restamp><span class="cell">[[cell]]</span></template>
                </th>
              </template>
              <template is="dom-if" if="[[!_isRowHeader(rowHeader,index)]]" restamp>
                <td numeric$="[[_isNumericColumn(index)]]" negative$="[[_isNegative(cell)]]">
                  <template is="dom-if" if="[[filter]]" restamp>
                    <editable-table-filter column-number="[[index]]" text$="[[cell]]" filtered$="[[_isFiltered(index,filterColumn)]]"></editable-table-filter>                      
                  </template>
                  <template is="dom-if" if="[[!filter]]" restamp><span class="cell">[[cell]]</span></template>
                </td>
              </template>
            </template>
          </tr> 
        </template>
      </tbody>
      <template is="dom-if" if="[[footer]]">
        <tfoot>
          <tr>
            <template is="dom-repeat" items$="[[__tfoot.0]]" as="cell" index-as="index">
              <template is="dom-if" if="[[_isRowHeader(rowHeader,index)]]">
                <th scope="row" numeric$="[[_isNumericColumn(index)]]">[[cell]]</th>
              </template>
              <template is="dom-if" if="[[!_isRowHeader(rowHeader,index)]]">
                <td numeric$="[[_isNumericColumn(index)]]" negative$="[[_isNegative(cell)]]">[[cell]]</td>
              </template>
            </template>
          </tr> 
        </tfoot>
      </template>
    </table>
  </template>

  <script>
    Polymer({

      is: 'editable-table-display',

      listeners: {
        "change-sort-mode": "changeSortMode",
        "toggle-filter": "toggleFilter",
        'dropdown-select-changed': '_onColumnChange'
      },
      
      behaviors: [ 
        ResponsiveUtilityBehaviors,
        simpleColorsBehaviors,
        editableTableBehaviors.displayBehaviors 
      ],

      properties: {
        /**
         * Is the table in edit mode?
         */
        editMode: {
          type: Boolean,
          value: false
        },
        /**
         * Column for filtering
         */
        filterColumn: {
          type: Number,
          value: null
        },
        /**
         * Text for Filtering
         */
        filterText: {
          type: String,
          value: null
        },
        /**
         * Hide edit mode?
         */
        hideEditMode: {
          type: Boolean,
          value: false
        },
        /**
         * The selected table
         */
        selected: {
          type: Number,
          value: 1
        },
        /**
         * # of <th> in <thead>
         */
        thead: {
          type: Array,
          computed: '_getThead(data,columnHeader)'
        },
        /**
         * # of <tr> in <tbody>
         */
        tbody: {
          type: Array,
          computed: '_getTbody(data,columnHeader,footer)'
        },
      },
      /**
        * initialize the responsive columns menu
        */
      _sortData: function(column,type){
        if (this.__backupData === undefined) this.__backupData = this.tbody.slice();
        if(type !== "none"){
          let temp = this.tbody.slice();
          for(let i = 0; i<temp.length; i++){
            temp[i].unshift(temp[i][column]);
          }
          if(type === "asc") {
            temp.sort();
          } else {
            temp.reverse();
          }
          for(let i = 0; i<temp.length; i++){
            this.set('tbody.'+i,[]);
            this.set('tbody.'+i,temp[i].slice(1));
          }
        } else {
          for(let i = 0; i<this.__backupData.length; i++){
            this.set('tbody.'+i,[]);
            this.set('tbody.'+i,this.__backupData[i].slice(1));
          }
        }
      },
      /**
        * Handle sort button click
        */
      changeSortMode: function(e){
        if(e.detail.sortMode === "asc"){
          e.detail.setSortMode("desc");
        } else if(e.detail.sortMode === "desc"){
          e.detail.setSortMode("none");
        } else {
          e.detail.setSortMode("asc");
        }
        this._sortData(e.detail.columnNumber,e.detail.sortMode);
      },

      /**
        * sets a column's cells to filtered when in filtered mode so that filter can toggle
        */
      _isFiltered: function(column,filterColumn){
        return filterColumn !== null && filterColumn === column;
      },

      /**
        * sets a cell's numeric style
        */
      _isNumericColumn: function(col){
        let numeric = true;
        for(let i=0; i<this.tbody.length; i++){
          if (!this._isNumeric(this.tbody[i][col])) numeric = false;
        }
        return numeric;
      },

      /**
        * sets a cell's numeric style
        */
      _isNumeric: function(cell){
        return !isNaN(cell.trim().replace(/\$/g, ''));
      },

      /**
        * sets a cell's numeric style
        */
      _isNegative: function(cell){
        return this._isNumeric(cell) && cell.trim().indexOf('-') === 0;
      },

      /**
        * Handle filter based on collumn and text of cell that is clicked
        */
      filterRows: function(filterColumn,filterText){
        if(filterColumn !== null && filterText !== null) {
          return function(tr) {
            return tr[filterColumn].toLowerCase().trim() === filterText.toLowerCase().trim();
          };
        }
        else {
          return null;
        }
      },

      /**
        * Handle filter button click
        */
      toggleFilter: function(e){
        this.filterText = !e.detail.filtered ? e.detail.text : null;
        this.filterColumn = !e.detail.filtered ? e.detail.columnNumber : null;
      },
      /**
        * Handle column dropdown-select change
        */
      _onColumnChange: function(e){
        this.selected = e.detail.value;
        this._updateCols(parseInt(e.detail.value)); 
      },
      /**
        * update the responsive columns menu
        */
      _updateCols: function(selected){
        this.$.table.removeAttribute('default-xs-display');
        let cols = this.$.table.querySelectorAll('th,td');
        this.$.table.setAttribute('transition',true);
        setTimeout(function(){
          for(let i=0; i< cols.length; i++){
            let col = cols[i], index = col.cellIndex, delay;
            if(index === 0 || index === selected) {
              col.removeAttribute('xs-hidden');
            } else {
              col.setAttribute('xs-hidden',true)
            }
          }
        }, 200);
        this.$.table.removeAttribute('transition');
      },
      /**
        * Calculate the number of <th> in <thead>
        */
      _getThead: function(data,columnHeader){
        let root = this;
        if(data !== undefined && data !== null && data.length > 0 && columnHeader){
          return data.slice(0,1);
        }
        return [];
      },
      /**
        * Calculate the number of <tr> in <tbody>
        */
      _getTbody: function(data,columnHeader,footer){
        if(data !== undefined && data !== null && data.length > 0){
          let ch = columnHeader ? 1 : 0, tbody;
          if(footer) {
            tbody = data.slice(ch,data.length-1);
            this.__tfoot = data.slice(data.length-1);
          } else {
            tbody = data.slice(ch,data.length);
            this.__tfoot = [];
          }
          return tbody;
        }
        return [];
      },
      /**
        * Calculate if the cell is a th or td
        */
      _isRowHeader: function(rowHeader,index){
        return index === 0 && rowHeader;
      }
    });
  </script>
</dom-module>
